<!DOCTYPE html>
<html>
<head>
	<!-- shims -->
	<script src="./midi-js/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="./midi-js/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="./midi-js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js -->
	<script src="./midi-js/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="./midi-js/js/midi/gm.js" type="text/javascript"></script>
	<script src="./midi-js/js/midi/loader.js" type="text/javascript"></script>
	<script src="./midi-js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="./midi-js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="./midi-js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="./midi-js/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="./midi-js/js/util/dom_request_script.js" type="text/javascript"></script>

	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>

<style>
		.black_key { height:100px; background:black; position: absolute; top:650px; left:100px}
		.white_key { height:150px; background:white; position: absolute; top:650px; left:100px}

		button { width:50px;}

		#whiteBoard { height:250px; width:250px;
		    					position:absolute; top:320px; left:250px;
		  						border:5px solid black;
									 background: linear-gradient(to top right,  #fffc99, #ff4733);
								}

		form { display:inline;
     			margin:0px;
     			padding:0px;
	 				}

	 #footer {	top:900px;
							position: absolute;
							background-color: #fffc99;
						}
	#header{
						background-color: #ff7c4d;
						position: absolute;
					}
		h2 {	left:250px;
					position: absolute;
					top:75px;
	 		 }
	#controls{	top:200px;
							position: absolute;
							left:50px;
						}

</style>

<body>

	<div id="header">
		<img src="icons/png/accordion.png" title="Accordion">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/bagpipes.png"title="Bagpipes">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/banjo.png" title="Banjo">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/fiddle.png" title="Fiddle">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/frenchhorn.png" title="French Horn">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/guitar.png" title="Guitar">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/harmonica.png" title="Harmonica">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/ocarina.png" title="Ocarina">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/organ.png" title="Organ">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/piccolo.png" title="Picolo">
		<br>
	</div>
	<br>

	<h2>MIDI Keyboard & Music Box
		<br>&nbsp;&nbsp;&nbsp;&nbsp;Christine Tse &#8226; 20233811
	</h2>

	<br><br><br><br><br><br>

<div id="controls">
  <label for="amplitude">MIDI Amplitude (0-127):</label>
  <input type="range" id="amplitude" min="0" max="127" value="100">

	&nbsp; &nbsp;&nbsp; &nbsp;
	<label for="pitch">MIDI Pitch (21-108):</label>
	<input type="range" id="pitch" min ="21" max="85" value="60">
	<br><br>

	<label for="instrument">MIDI Instrument:</label>
	<select id="instrument">
  <option value="accordion">Accordion</option>
  <option value="bagpipe">Bagpipe</option>
  <option value="banjo">Banjo</option>
	<option value="oragn">Church Organ</option>
  <option value="fiddle">Fiddle</option>
  <option value="horn">French Horn</option>
	<option value="guitar">Guitar</option>
  <option value="harmonica">Harmonica</option>
	<option value="ocarina">Ocarina</option>
  <option value="piccolo">Piccolo</option>
	</select>

		&nbsp; &nbsp;	&nbsp; &nbsp;	&nbsp; &nbsp;&nbsp;	&nbsp; &nbsp;

		<label>Music Mode: </label>&nbsp;
		<form>
			<input type="radio" name="musicMode" value="single" checked>Single Note &nbsp;
			<input type="radio" name="musicMode" value="major">Major Chord &nbsp;
			<input type="radio" name="musicMode" value="minor">Minor Chord
		</form>

	<br><br>
</div>


<form>
<!-- First we draw the white keys -->

<button type="button" class="white_key" data-piano-key-number="0" style="left:50px"></button>
<button type="button" class="white_key" data-piano-key-number="2" style="left:100px"></button>
<button type="button" class="white_key" data-piano-key-number="4" style="left:150px"></button>
<button type="button" class="white_key" data-piano-key-number="5" style="left:200px"></button>
<button type="button" class="white_key" data-piano-key-number="7" style="left:250px"></button>
<button type="button" class="white_key" data-piano-key-number="9" style="left:300px"></button>
<button type="button" class="white_key" data-piano-key-number="11" style="left:350px"></button>
<button type="button" class="white_key" data-piano-key-number="12" style="left:400px"></button>
<button type="button" class="white_key" data-piano-key-number="14" style="left:450px"></button>
<button type="button" class="white_key" data-piano-key-number="16" style="left:500px"></button>
<button type="button" class="white_key" data-piano-key-number="17" style="left:550px"></button>
<button type="button" class="white_key" data-piano-key-number="19" style="left:600px"></button>
<button type="button" class="white_key" data-piano-key-number="21" style="left:650px"></button>
<button type="button" class="white_key" data-piano-key-number="23" style="left:700px"></button>

<!-- Now we draw the black keys, so they appear on top of the white keys
(in a web page, things included later are normally shown on top of things included earlier) -->

<button type="button" class="black_key" data-piano-key-number="1" style="left:75px"></button>
<button type="button" class="black_key" data-piano-key-number="3" style="left:125px"></button>
<button type="button" class="black_key" data-piano-key-number="6" style="left:225px"></button>
<button type="button" class="black_key" data-piano-key-number="8" style="left:275px"></button>
<button type="button" class="black_key" data-piano-key-number="10" style="left:325px"></button>
<button type="button" class="black_key" data-piano-key-number="13" style="left:425px"></button>
<button type="button" class="black_key" data-piano-key-number="15" style="left:475px"></button>
<button type="button" class="black_key" data-piano-key-number="18" style="left:575px"></button>
<button type="button" class="black_key" data-piano-key-number="20" style="left:625px"></button>
<button type="button" class="black_key" data-piano-key-number="22" style="left:675px"></button>
</form>

<div id="whiteBoard">
</div>

	<div id="footer">
		<img src="icons/png/accordion.png" title="Accordion">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/bagpipes.png"title="Bagpipes">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/banjo.png" title="Banjo">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/fiddle.png" title="Fiddle">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/frenchhorn.png" title="French Horn">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/guitar.png" title="Guitar">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/harmonica.png" title="Harmonica">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/ocarina.png" title="Ocarina">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/organ.png" title="Organ">&nbsp;&nbsp;&nbsp;&nbsp;
		<img src="icons/png/piccolo.png" title="Picolo">
		<br><br>
		&nbsp; <p style="font-size:90%;">	&#8226; Icons made by <a href=" http://www.freepik.com">Freepik</a> &#8226;</p>
	</div>


<script>

var this_pitch;
var lowest_pitch; // The MIDI pitch number for the first (left) keyboard key
var this_instrument;
var whiteBoard_mode = false;
var whiteboard_last_note = -99;
var musicMode;

function handlePianoKeyPress(evt) {

  var this_key, this_amplitude;

  // Show a simple message in the console
  console.log("Key press event!");

  this_key = $(evt.target).data("pianoKeyNumber");

	lowest_pitch=$("#pitch").val();
	lowest_pitch=parseInt(lowest_pitch);

  // Extract the amplitude value from the slider
  this_amplitude=$("#amplitude").val();
  // Convert the string into actual values
  this_amplitude=parseInt(this_amplitude);

	//find pitch of key
	this_pitch = lowest_pitch + parseInt(this_key);
	console.log("Pitch: ", this_pitch);

	instrumentSelection();

	console.log(this_instrument);
  // Use the two numbers to start a MIDI note
	musicModeCheck(this_amplitude);

};

function handlePianoKeyRelease(evt) {
  // Show a simple message in the console
  console.log("Key release event!");

  // Send the note off message to match the pitch of the current note on event
  // Handle chord mode
	musicModeCheckOFF();
};

var lowest_valid_pitch = 21;
var valid_pitch_range = 87;
var amplitude_range= 127;

function handleWhiteboardPress(evt){
	whiteBoard_mode = true;

	console.log("White Board press event!");

	var x = evt.pageX - $("#whiteBoard").offset().left;
	var y = evt.pageY - $("#whiteBoard").offset().top;
	if(x<5 || x>255 || y<5 || y>255){
		console.log("X: ", x, "Y: ", y, "\n Not in range!");
		return;
	}
	console.log("X: ", x)
	x=x-5;
	var x_fraction = x/250;

	console.log("Y: ", y);
	y=y-5;
	var y_fraction = y/250;

	//calcualting the pitch axis
	this_pitch = lowest_valid_pitch + (x_fraction * valid_pitch_range);
	this_pitch= parseInt(this_pitch);
	console.log("Pitch: ", this_pitch);

	whiteboard_last_note= this_pitch;

	//calcualting the amplitude axis
	var this_amplitude = y_fraction * amplitude_range;
	this_amplitude = 127- this_amplitude;
	this_amplitude= parseInt(this_amplitude);
	console.log("Amplitude: ", this_amplitude);

	instrumentSelection();
	musicModeCheck(this_amplitude);
};

function handleWhiteboardRelease(evt){
	whiteBoard_mode =false;
	console.log("White Board release event!");
	musicModeCheckOFF();
};

function handleWhiteboardMove(evt){

	if(whiteBoard_mode == true){
		if(whiteboard_last_note != -99)//a note has been played already
			musicModeCheckOFF();

		var x = evt.pageX - $("#whiteBoard").offset().left;
		var y = evt.pageY - $("#whiteBoard").offset().top;
		if(x<5 || x>255 || y<5 || y>255){
			console.log("X: ", x, "Y: ", y, "\n Not in range!");
			handleWhiteboardRelease(evt);
			return;
		}
		console.log("X: ", x)
		x=x-5;
		var x_fraction = x/250;

		console.log("Y: ", y);
		y=y-5;
		var y_fraction = y/250;

		//calcualting the pitch axis
		this_pitch = lowest_valid_pitch + (x_fraction * valid_pitch_range);
		this_pitch= parseInt(this_pitch);
		console.log("Pitch: ", this_pitch);

		whiteboard_last_note= this_pitch;

		//calcualting the amplitude axis
		var this_amplitude = y_fraction * amplitude_range;
		this_amplitude = 127- this_amplitude;
		this_amplitude= parseInt(this_amplitude);
		console.log("Amplitude: ", this_amplitude);

		//instrumentSelection();
		musicModeCheck(this_amplitude);
	}
};

function instrumentSelection(){
	//extract instrument selection
	this_instrument=$("#instrument").val();

	if (this_instrument == "accordion")
		MIDI.programChange(0, 21);
	else if (this_instrument == "guitar")
		MIDI.programChange(0, 25);
	else if (this_instrument == "bagpipe")
		MIDI.programChange(0, 109);
	else if (this_instrument == "banjo")
		MIDI.programChange(0, 105);
	else if (this_instrument == "oragn")
		MIDI.programChange(0, 19);
	else if (this_instrument == "fiddle")
		MIDI.programChange(0, 110);
	else if (this_instrument == "horn")
		MIDI.programChange(0, 60);
	else if (this_instrument == "harmonica")
		MIDI.programChange(0, 22);
	else if (this_instrument == "ocarina")
		MIDI.programChange(0, 79);
	else if (this_instrument == "piccolo")
		MIDI.programChange(0, 72);
};


function musicModeCheck(this_amplitude){
	// Handle chord mode
	musicMode = $(":radio[name=musicMode]:checked").val() //checks to see which chord mode

	if(musicMode == "single"){
		MIDI.noteOn(0, this_pitch, this_amplitude);
		console.log(musicMode);
	}
	else if(musicMode == "major"){
		if(this_pitch>101){
			MIDI.noteOn(0, this_pitch, this_amplitude);
			MIDI.noteOn(0, this_pitch-3, this_amplitude);
			MIDI.noteOn(0, this_pitch-7, this_amplitude);
		}
		else{
		MIDI.noteOn(0, this_pitch, this_amplitude);
		MIDI.noteOn(0, this_pitch+4, this_amplitude);
		MIDI.noteOn(0, this_pitch+7, this_amplitude);
		}
		console.log(musicMode);
	}
	else if(musicMode == "minor"){
		if(this_pitch>101){
			MIDI.noteOn(0, this_pitch, this_amplitude);
			MIDI.noteOn(0, this_pitch-4, this_amplitude);
			MIDI.noteOn(0, this_pitch-7, this_amplitude);
		}
		else{
		MIDI.noteOn(0, this_pitch, this_amplitude);
		MIDI.noteOn(0, this_pitch+3, this_amplitude);
		MIDI.noteOn(0, this_pitch+7, this_amplitude);
		}
		console.log(musicMode);
	}
};

function musicModeCheckOFF(){
	if(musicMode == "single")
	 MIDI.noteOff(0, this_pitch, 0);
	else if(musicMode == "major"){
		if(this_pitch>101){
			MIDI.noteOff(0, this_pitch, 0);
			MIDI.noteOff(0, this_pitch-3, 0);
			MIDI.noteOff(0, this_pitch-7, 0);
		}
		else{
			MIDI.noteOff(0, this_pitch, 0);
			MIDI.noteOff(0, this_pitch+4, 0);
			MIDI.noteOff(0, this_pitch+7, 0);
		}
	}
	else if(musicMode == "minor"){
		if(this_pitch>101){
			MIDI.noteOff(0, this_pitch, 0);
			MIDI.noteOff(0, this_pitch-4, 0);
			MIDI.noteOff(0, this_pitch-7, 0);
		}
		else{
			MIDI.noteOff(0, this_pitch, 0);
			MIDI.noteOff(0, this_pitch+3, 0);
			MIDI.noteOff(0, this_pitch+7, 0);
		}
	}
};


$( document ).ready( function() {
	MIDI.loadPlugin({
		soundfontUrl: "./midi-js/soundfont/",
		instrument: "accordion",
		onprogress: function(state, progress) {
			console.log(state, progress);
		},
		onsuccess: function() {

			// At this point the MIDI system is ready to be used
			MIDI.setVolume(0, 127); // Set the general volume level
			MIDI.programChange(0, 21); // Use the General MIDI 'accordion' number

			// Set up the event handlers for all the buttons
			$("button").on("mousedown", handlePianoKeyPress);
			$("button").on("mouseup", handlePianoKeyRelease);

			$("#whiteBoard").on("mousedown", handleWhiteboardPress);
			$("#whiteBoard").on("mouseup", handleWhiteboardRelease);

			$("#whiteBoard").on("mousemove", handleWhiteboardMove);

		}
	});
});

</script>

</body>
</html>

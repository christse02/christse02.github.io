<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>COMP4431 Video Process</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .container { width: 1200px; }
        .progress { margin-top: 20px; }
        .navbar-inverse .navbar-brand { color: white }
        .progress-bar {
            -webkit-transition: none;
            -moz-transition: none;
            -ms-transition: none;
            -o-transition: none;
            transition: none;
        }â€‹
        img { border: 0 }
    </style>
</head>
<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand">COMP4431 Video Processor</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <br>
        <br>
        <br>
        <div class="row">
            <div class="col-sm-4 col-md-4 col-lg-4">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#input-video-1-tab" aria-controls="home" role="tab" data-toggle="tab">Input Video 1</a></li>
                    <li role="presentation"><a href="#input-video-2-tab" aria-controls="profile" role="tab" data-toggle="tab">Input Video 2</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="input-video-1-tab">
                        <br>
                        <div class="panel panel-default">
                            <div class="panel-heading">Input 1</div>
                            <div class="panel-body">
                                <video id="input-video-1" width="320px" height="180px" controls preload="auto"></video>
                            </div>
                        </div>
                        <hr>
                        <div class="panel panel-default">
                            <div class="panel-heading">Input 1 Frame</div>
                            <div class="panel-body">
                                <img id="input-video-1-frame" width="320px" height="180px">
                            </div>
                        </div>
                        <br>
                        <button class="btn btn-info btn-block" id="change-input-video-1">Change Input Video 1</button>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="input-video-2-tab">
                        <br>
                        <div class="panel panel-default">
                            <div class="panel-heading">Input 2</div>
                            <div class="panel-body">
                                <video id="input-video-2" width="320px" height="180px" controls preload="auto"></video>
                            </div>
                        </div>
                        <hr>
                        <div class="panel panel-default">
                            <div class="panel-heading">Input 2 Frame</div>
                            <div class="panel-body">
                                <img id="input-video-2-frame" width="320px" height="180px">
                            </div>
                        </div>
                        <br>
                        <button class="btn btn-info btn-block" id="change-input-video-2">Change Input Video 2</button>
                    </div>
                </div>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="dropdown active">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Effect - <span class="title">Reverse</span><span class="caret"></span></a>
                        <ul class="dropdown-menu" id="waveform-dropdown-menu">
                            <li role="presentation" class="active"><a class="effect-category" href="#reverse" role="tab" data-toggle="tab">Reverse</a></li>
                            <li role="presentation"><a class="effect-category" href="#motionBlur" role="tab" data-toggle="tab">Motion Blur</a></li>
                            <li role="presentation"><a class="effect-category" href="#earthquake" role="tab" data-toggle="tab">Earthquake</a></li>
                            <li role="presentation"><a class="effect-category" href="#crossFade" role="tab" data-toggle="tab">Cross Fade</a></li>
                        </ul>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="reverse">
                        <h5>Parameters</h5>
                        <p>No parameters avaliable</p>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="motionBlur">
                        <h5>Parameters</h5>
                        <label for="decay-rate">Frames:</label>
                        <div class="form-inline">
                            <div class="form-group">
                                <input class="form-control" id="blur-frames" type="number" value="2" min="2" step="1">
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="earthquake">
                        <h5>Parameters</h5>
                        <label for="decay-rate">Strength:</label>
                        <div class="form-inline">
                            <div class="form-group">
                                <input class="form-control" id="earthquake-strength" type="number" value="25" min="3" step="2">
                            </div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="crossFade">
                        <h5>Parameters</h5>
                        <label for="decay-rate">Overlapped Duration:</label>
                        <div class="form-inline">
                            <div class="form-group">
                                <div class="input-group">
                                    <input class="form-control" id="crossFade-duration" type="number" value="3" min="1" step="1">
                                    <div class="input-group-addon">seconds</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <button class="btn btn-primary" id="apply-effect">Apply</button>
            </div>
            <div class="col-sm-4 col-md-4 col-lg-4">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#output-video-tab" aria-controls="home" role="tab" data-toggle="tab">Output Video</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="output-video-tab">
                        <br>
                        <div class="panel panel-default">
                            <div class="panel-heading">Output</div>
                            <div class="panel-body">
                                <video id="output-video" width="320px" height="180px" controls preload="auto"></video>
                            </div>
                        </div>
                        <hr>
                        <div class="panel panel-default">
                            <div class="panel-heading">Output Frame</div>
                            <div class="panel-body">
                                <img id="output-video-frame" width="320px" height="180px">
                            </div>
                        </div>
                        <br>
                        <button class="btn btn-info btn-block" id="play-both">Play Input and Output Together</button>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /container -->

    <div class="modal" tabindex="-1" role="dialog" id="import-video-modal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>-->
                    <h4 class="modal-title">Importing video...</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <video preload="auto" id="import-video-preview" width="100%"></video>
                    </div>
                    <div class="row">
                        <div>
                            <div class="progress">
                                <div id="import-progress" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal" tabindex="-1" role="dialog" id="progress-modal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>-->
                    <h4 class="modal-title">Processing Effect...</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div>
                            <div class="progress">
                                <div id="effect-progress" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <input type="file" id="file-select" style="display: none"> <!-- Hidden file filde for loading local video -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="VideoFrame.min.js"></script>
    <script src="whammy.min.js"></script>
    <script>

    // Check for the various File API support.

    if (!(window.File && window.FileReader && window.FileList && window.Blob && Array.prototype.indexOf)) {
        alert("Your browser does not support all features that are needed in this assignment!\nPlease use another browser, e.g. Google Chrome.");
        throw("Your browser does not support all features that are needed in this assignment!\nPlease use another browser, e.g. Google Chrome.");
    }

    // Great success! All the File APIs are supported

    var frameRate = 25; // We assume all video use 25 frames per second
    var selectedEffect = "reverse"; // The currently selected effect
    var importingFor = null; // The current target for the import video process
    var importer = null; // The global video importer instance
    var importBuffer = []; // The frames buffer for importing video
    var input1FramesBuffer = []; // The imported frames buffer for video 1
    var input2FramesBuffer = []; // The imported frames buffer for video 2
    var processFramesBuffer = []; // The frames buffer for processed frames
    var outputFramesBuffer = []; // The frames buffer for the output video
    var jobs = {jobID: 0, jobs: []}; // The jobs queue

    // Helper function for creating a standalone copy of the source buffer
    function copyBuffer(source) {
        return $.extend(true, [], source);
    }

    // Helper function for creating a new canvas of specific width and height
    function getCanvas(w, h) {
        var c = document.createElement('canvas');
        c.width = w;
        c.height = h;
        return c;
    };

    // Helper function, draw an image on target canvas context with a specific opatcity
    function draw(ctx, img, opacity) {
        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.drawImage(img, 0, 0);
        ctx.restore();
    }

    // Show the select file dialog
    // Reset the <input type='file' /> first
    function startUpload(evt) {
        importingFor = evt.target;
        $("#file-select").wrap("<form>").closest('form').get(0).reset();
        $("#file-select").unwrap();
        $("#file-select").click();
    }

    // Import the video as frames, store the result in the frames buffer
    function importVideo() {
        // Check if the importer is ready
        if(!importer || !importer.video || !importer.video.duration || !importer.video.videoWidth || !importer.video.videoHeight) {
            setTimeout(importVideo, 10);
            return;
        }

        // Check if the importer and its video file are ready
        if(!importer.video.buffered.end(0) > 0) {
            setTimeout(importVideo, 10);
            return;
        }

        // Check if there are still more frames for import
        if(importer && !importer.video.ended) {
            // Capture the current frame
            captureFrame(importer, importBuffer);

            // Update the progress bar
            updateProgressBar("#import-progress", importer.video.currentTime / importer.video.duration * 100);

            // Process the next frame

            // Add an one time only event handler for the "seeked" event of the target video.
            // This ensure that the `importVideo()` (and hence the `captureFrame()`) is
            // only invoked after the video has changed the frame.
            $(importer.video).one("seeked", importVideo);

            // Go to the next frame
            importer.seekForward();
        } else {
            // Done importing
            updateProgressBar("#import-progress", 100);

            // Find the correct target of the import
            var target = null;
            if($(importingFor).attr("id") === "change-input-video-1") {
                target = $("#input-video-1");
                input1FramesBuffer = copyBuffer(importBuffer);
            } else {
                target = $("#input-video-2");
                input2FramesBuffer = copyBuffer(importBuffer);
            }

            // Build a new video based on the imported frames
            var resultVideo = buildVideo(importBuffer);

            // Set the resulted video as the 'src' of the import target
            target.attr("src", URL.createObjectURL(resultVideo));

            // Hide the import dialog
            $("#import-video-modal").modal("hide");
        }
    }

    // Build a video from frames stored in a buffer
    // The input buffer will be emptied after this process!
    function buildVideo(buffer) {
        // Create a new Whammy video encoder instance, with specific frame rate.
        var encoder = new Whammy.Video(frameRate);

        // Add the frames to the encoder by `add()`
        while(buffer.length > 0) {
            encoder.add(buffer.shift());
        }

        // Build the video using `compile()`
        return encoder.compile();
    }

    // Handler for the <input type='file' /> change event
    function changeVideo(event) {
        // The allowed video formats
        var validFileType = ["video/mp4", "video/avi", "video/webm", "video/mov", "video/quicktime", "video/ogg"];

        // Get the selected file
        var files = event.target.files;
        if(files.length >= 1) { // If the user clicked 'Cancel', files.length will be 0
            var file = files[0]; // We only handle the first selected file and ignore the rest
            // Check if the MIME type of the selected file is one of the allowed video formats
            if(validFileType.indexOf(file.type) > -1) {
                var reader = new FileReader();
                // Set up the 'onloadedend' event handler for the file reader
                // The event is triggered while the browser loaded the entire video file into
                // the memory. The loaded file is stored in 'this.result'.
                reader.onloadend = function() {
                    // First, convert the read file into data URL format and set it to the 'src' of
                    // the <video id="import-video-preview">. We will use it for importing the video
                    // and capturing the frames.
                    $("#import-video-preview").attr("src", URL.createObjectURL(new Blob([this.result])));

                    // Show the import video dialog
                    $("#import-video-modal").modal("show");

                    // Create a VideoFrame object instance. It is used for seeking the video
                    // forward frame by frame.
                    importer = VideoFrame({
                        id: "import-video-preview",
                        frameRate: frameRate,
                    });

                    // Start the import process
                    importVideo();
                };
                // Start reading in the selected file, in the format of 'array buffer'
                reader.readAsArrayBuffer(file);
            } else {
                alert("Not a valid video file!");
            }
        }
    }

    // Capture the current frame as an image in the 'webp' format.
    // If a buffer is passed in using the second parameter,
    // the captured frame is added to the back of that buffer.
    // The captured frame is directly returned.
    function captureFrame(target, resultBuffer) {
        // The input may be an importer instance or a real video instance
        if(target.video) {
            target = target.video;
        }
        var w = target.videoWidth;
        var h = target.videoHeight;
        var tmpCanvas = getCanvas(w, h);
        var tmpCtx = tmpCanvas.getContext('2d');
        // Draw the current frame displayed onto the temporary canvas context
        tmpCtx.drawImage(target, 0, 0, w, h);

        var result = tmpCanvas.toDataURL("image/webp");

        if(resultBuffer !== undefined) {
            // Add the captured frame to the back of the targeting buffer,
            // in the format of 'webp', in data URL format.
            resultBuffer.push(result);
        }

        return result;
    }

    // Handler of video timechanged event
    function updateFrames(evt) {
        var target = evt.target;
        var capturedFrame = captureFrame(target);

        // Locate the target <img /> to be updated
        var targetFrameDisplay = null
        if($(target).attr("id") === "input-video-1") {
            targetFrameDisplay = $("#input-video-1-frame");
        } else if($(target).attr("id") === "input-video-2") {
            targetFrameDisplay = $("#input-video-2-frame");
        } else if($(target).attr("id") === "output-video") {
            targetFrameDisplay = $("#output-video-frame");
        }

        // Show the captured frame
        targetFrameDisplay.attr("src", capturedFrame);
    }

    // This function responsible for processing the jobs queued in the `jobs`.
    // If all jobs in the queue are handled, it takes the frames stored in the
    // `outputFramesBuffer` and builds a video. The video is then set as the 'src'
    // of the <video id='output-video'></video>.
    function processJobs() {
        if(jobs.jobID < jobs.jobs.length) {
            var job = jobs.jobs[jobs.jobID++];
            job.callback(job.frameNumber, job.parameters);
            updateProgressBar("#effect-progress", jobs.jobID / jobs.jobs.length * 100);
            setTimeout(processJobs, 1);
        } else {
            var resultVideo = buildVideo(outputFramesBuffer);
            $("#output-video").attr("src", URL.createObjectURL(resultVideo));
            updateProgressBar("#effect-progress", 100);
            $("#progress-modal").modal("hide");
        }
    }

    // Definition of various video effects
    //
    // `effects` is an object with unlimited number of members.
    // Each member of `effects` represents an effect or a group of effects.
    // Each effect is an object, with two member functions:
    // - setup() which responsible for gathering different parameters
    //           of that effect, copying input frames to specific buffer(s) and
    //           queueing jobs into the job queue.
    // - process() which responsible for processing of individual frames
    // and optionally a third member functions:
    // - cleanUp() which handles after the per frame processing
    var effects = {
        reverse: {
            setup: function() {
                outputFramesBuffer = copyBuffer(input1FramesBuffer);
                jobs.jobs = [];
                jobs.jobID = 0;
                jobs.jobs.push({
                    frameNumber: 0,
                    callback: effects.reverse.process
                });
            },
            process: function() {
                outputFramesBuffer.reverse();
                updateProgressBar("#effect-progress", 75);
            }
        },
        motionBlur: {
            setup: function() {
              outputFramesBuffer = [];
              processFramesBuffer = [];
              jobs.jobs = [];
              jobs.jobID = 0;

              for(var idx = 0; idx < input1FramesBuffer.length; ++idx) {
                  jobs.jobs.push({
                      frameNumber: idx,
                      callback: effects.motionBlur.process,
                      parameters: { frames: parseInt($("#blur-frames").val()) }
                  });
              }

            },
            process: function(idx, parameters) {
              var w = $("#input-video-1").get(0).videoWidth;
              var h = $("#input-video-1").get(0).videoHeight;
              var tmpCanvas = getCanvas(w, h);
              var tmpCtx = tmpCanvas.getContext('2d');
              var outputCanvas = getCanvas(w, h);
              var outputCtx = outputCanvas.getContext('2d');

              var frames = parameters.frames;

              var img = new Image;
              img.src = input1FramesBuffer[idx];
              tmpCtx.drawImage(img, 0, 0);
              processFramesBuffer.push(tmpCtx.getImageData(0, 0, w, h));

              if(processFramesBuffer.length > frames) {
                  processFramesBuffer.shift(); // shift() removes the first element from an array
              }

              var outputImageData = outputCtx.createImageData(w, h);
              for(var j = 0; j < outputImageData.data.length; ++j) {
                  for(var i = 0; i < processFramesBuffer.length; ++i) {
                      outputImageData.data[j] += processFramesBuffer[i].data[j] / frames;
                  }
              }
              outputCtx.putImageData(outputImageData, 0, 0);

              outputFramesBuffer.push(outputCanvas.toDataURL("image/webp"));

            }
        },
        earthquake:  {
            setup: function() {
              outputFramesBuffer = [];
              jobs.jobs = [];
              jobs.jobID = 0;
              for(var idx = 0; idx < input1FramesBuffer.length; ++idx) {
              jobs.jobs.push({
                  frameNumber: idx,
                  callback: effects.earthquake.process,
                  parameters: { strength: parseInt($("#earthquake-strength").val()) }
              });
              }

            },
            process: function(idx, parameters) {
              var w = $("#input-video-1").get(0).videoWidth;
              var h = $("#input-video-1").get(0).videoHeight;
              var outputCanvas = getCanvas(w, h);
              var outputCtx = outputCanvas.getContext('2d');

              var strength = parameters.strength;

              var dx = strength + Math.floor(Math.random() * strength * 2 - strength);
              var dy = strength + Math.floor(Math.random() * strength * 2 - strength);

              var sw = w - 2 * strength;
              var sh = h - 2 * strength;

              var img = new Image;
              img.src = input1FramesBuffer[idx];
              outputCtx.drawImage(img, dx, dy, sw, sh, 0, 0, w, h);

              outputFramesBuffer.push(outputCanvas.toDataURL("image/webp"));

            }
        },
        transition: {
            crossFade: {
                setup: function() {
                  var fadeDuration = parseInt($("#crossFade-duration").val());
                  var fadeNumberOfFrames = fadeDuration * frameRate;
                  outputFramesBuffer = copyBuffer(input1FramesBuffer.slice(0, -fadeNumberOfFrames));
                  transitionBuffer = copyBuffer(input1FramesBuffer.slice(-fadeNumberOfFrames));
                  transitionBuffer2 = copyBuffer(input2FramesBuffer.slice(0, fadeNumberOfFrames));

                  jobs.jobs = [];
                  jobs.jobID = 0;
                  for(var idx = 0; idx < transitionBuffer.length; ++idx) {
                      jobs.jobs.push({
                          frameNumber: idx,
                          callback: effects.transition.crossFade.process,
                          parameters: { fadeNumberOfFrames: fadeNumberOfFrames }
                      });
                  }

                },
                process: function(idx, parameters) {
                  var w = $("#input-video-1").get(0).videoWidth;
                  var h = $("#input-video-1").get(0).videoHeight;
                  var outputCanvas = getCanvas(w, h);
                  var outputCtx = outputCanvas.getContext('2d');

                  var fadeNumberOfFrames = parameters.fadeNumberOfFrames;

                  var img = new Image;
                  img.src = transitionBuffer[idx];
                  var img2 = new Image;
                  img2.src = transitionBuffer2[idx];
                  outputCtx.clearRect(0, 0, w, h);

                  var frac = idx / fadeNumberOfFrames;

                  draw(outputCtx, img, 1 - frac);
                  draw(outputCtx, img2, frac);

                  outputFramesBuffer.push(outputCanvas.toDataURL("image/webp"));

                },
                cleanUp: function(idx, parameters) {
                  jobs.jobs.push({
                      frameNumber: 0,
                      callback: effects.transition.crossFade.cleanUp,
                      parameters: { fadeNumberOfFrames: fadeNumberOfFrames }
                  });

                  var fadeNumberOfFrames = parameters.fadeNumberOfFrames;
                  var remainingFrames = copyBuffer(input2FramesBuffer.slice(fadeNumberOfFrames));
                  outputFramesBuffer = outputFramesBuffer.concat(remainingFrames);

                }
            },
        }
    };

    // Handler for the "Apply" button click event
    function applyEffect(e) {
        $("#progress-modal").modal("show");
        updateProgressBar("#effect-progress", 0);
        // Check which one is the actively selected effect
        switch(selectedEffect) {
            case "reverse":
                effects.reverse.setup();
                break;
            case "motionBlur":
                effects.motionBlur.setup();
                break;
            case "earthquake":
                effects.earthquake.setup();
                break;
            case "crossFade":
                effects.transition.crossFade.setup();
                break;
            default:
                // Do nothing
                $("#progress-modal").modal("hide");
                return;
        }
        // Start processing the jobs queued.
        processJobs();
    }

    // Handler for tab changing.
    function changeTabs(e) {
        selectedEffect = $(e.target).attr("href").substring(1);
        $(e.target).parents("li").find("span.title").html($(e.target).html());
    }

    // Play both the input videos together with the output video
    function playBoth() {
        $("#input-video-1").get(0).currentTime = 0;
        $("#input-video-2").get(0).currentTime = 0;
        $("#output-video").get(0).currentTime = 0;
        $("#input-video-1").get(0).play();
        $("#input-video-2").get(0).play();
        $("#output-video").get(0).play();
    }

    // Update the targeting progress bar to specific value.
    // The progress value is displayed in 2 decimal places.
    function updateProgressBar(target, newValue) {
        newValue = Math.floor(parseFloat(newValue) * 100) / 100;
        $(target).width(newValue + "%").text(newValue + "%");
    }

    // Set up the event handlers for various GUI elements
    // when the page is fully loaded.
    $(function() {
        $("#input-video-1, #input-video-2, #output-video").on("timeupdate", updateFrames);
        $("#change-input-video-1, #change-input-video-2").on("click", startUpload);
        $("#file-select").on("change", changeVideo);
        $("#play-both").on("click", playBoth);
        $('a[data-toggle="tab"].effect-category').on('show.bs.tab', changeTabs);
        $("#apply-effect").on("click", applyEffect);
    });
    </script>
</body>
</html>
